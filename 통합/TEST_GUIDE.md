# 자율주행 시스템 테스트 가이드

## 📋 목차
1. [시작하기 전에](#시작하기-전에)
2. [코드 수정 사항](#코드-수정-사항)
3. [테스트 순서](#테스트-순서)
4. [개별 센서 테스트](#개별-센서-테스트)
5. [통합 테스트](#통합-테스트)
6. [시뮬레이션 테스트](#시뮬레이션-테스트)
7. [문제 해결](#문제-해결)

---

## 🚀 시작하기 전에

### 1. 하드웨어 연결 확인
- [ ] 아두이노 USB 연결 (COM 포트 확인)
- [ ] 라이다 USB 연결 (COM 포트 확인)
- [ ] 카메라 2대 USB 연결
- [ ] 배터리 220V → AC/DC 컨버터 연결
- [ ] 모터 드라이브 전원 연결

### 2. COM 포트 확인 방법
**Windows 장치 관리자에서 확인:**
1. `Win + X` → 장치 관리자
2. "포트(COM & LPT)" 확장
3. 아두이노와 라이다의 COM 포트 번호 확인

**예시:**
```
포트(COM & LPT)
  ├─ Arduino Uno (COM4)
  └─ USB Serial Device (COM3)  ← 라이다
```

### 3. config.py 설정
[config.py](config.py)에서 포트 번호를 실제 환경에 맞게 수정:

```python
ARDUINO_PORT = 'COM4'    # 아두이노 포트 (장치 관리자에서 확인)
LIDAR_PORT = 'COM3'      # 라이다 포트 (장치 관리자에서 확인)
```

---

## 🔧 코드 수정 사항

### 주요 수정 내역:
1. **Lib_LiDAR.py** - 라이다 각도 범위 처리 수정 (350~10도 처리)
2. **sensors.py, control.py, main.py** - import 경로 수정
3. **테스트 프로그램 6개 추가**

---

## 📝 테스트 순서

**⚠️ 중요: 반드시 이 순서대로 테스트하세요!**

```
1. 시뮬레이션 테스트 (하드웨어 불필요)
   ↓
2. 초음파 센서 테스트
   ↓
3. 모터 제어 테스트
   ↓
4. 라이다 테스트
   ↓
5. 카메라 테스트
   ↓
6. 통합 테스트
   ↓
7. 실제 자율주행 (main.py)
```

---

## 🧪 개별 센서 테스트

### 1️⃣ 시뮬레이션 테스트 (하드웨어 불필요)
**목적:** 제어 로직이 올바르게 작동하는지 검증

```bash
cd 통합
python tests/test_simulation.py
```

**예상 결과:**
```
시나리오 1: 직진 주행 (장애물 없음)
  명령: ⬆️ 전진 (Forward)
  ✅ PASS

시나리오 4: 전방 장애물 감지 (라이다)
  명령: 🛑 정지 (Stop)
  ✅ PASS
```

**확인 사항:**
- 8개 시나리오가 모두 PASS
- 각 상황에서 올바른 명령이 내려지는지 확인

---

### 2️⃣ 초음파 센서 테스트
**목적:** 아두이노와 초음파 센서 6개가 정상 작동하는지 확인

**준비물:**
- 아두이노 연결 (USB)
- 초음파 센서 6개 연결

**실행:**
```bash
cd 통합
python tests/test_ultrasonic.py
```

**예상 출력:**
```
[프레임 5]
  전방(F):     25 cm
  좌전방(FL):  30 cm
  우전방(FR):  28 cm
  후방(R):     50 cm
  좌후방(RL):  45 cm
  우후방(RR):  48 cm
```

**확인 사항:**
- [ ] 6개 센서 모두 거리 값이 출력되는가?
- [ ] 손을 센서 앞에 대면 거리 값이 변하는가?
- [ ] 안전거리(20cm) 이내에 물체가 있으면 경고가 뜨는가?

**종료:** `Ctrl + C`

---

### 3️⃣ 모터 제어 테스트
**목적:** DC모터와 서보모터가 키보드 명령에 따라 작동하는지 확인

**⚠️ 주의:** 차량을 들어올리거나 바퀴가 지면에 닿지 않게 하세요!

**준비물:**
- 아두이노 연결
- 모터 드라이브 전원 연결
- DC 모터 + 서보모터 연결

**실행:**
```bash
cd 통합
python tests/test_motor.py
```

**조작법:**
- `W` - 전진
- `S` - 정지
- `A` - 좌회전
- `D` - 우회전
- `X` - 후진
- `Q` - 종료

**확인 사항:**
- [ ] 전진(W): DC모터가 앞으로 회전하는가?
- [ ] 정지(S): 모터가 멈추는가?
- [ ] 좌회전(A): 서보모터가 왼쪽으로 회전하는가?
- [ ] 우회전(D): 서보모터가 오른쪽으로 회전하는가?

**서보모터 각도 조정:**
만약 조향이 제대로 안 된다면 [motor_control.ino:29-33](firmware/motor_control/motor_control.ino#L29-L33)에서 각도 수정:

```cpp
int SERVO_CENTER = 90;        // 직진 (실제 차량에 맞게 조정)
int SERVO_LEFT_MAX = 60;      // 최대 좌회전
int SERVO_RIGHT_MAX = 120;    // 최대 우회전
```

---

### 4️⃣ 라이다 테스트
**목적:** 라이다가 장애물을 감지하는지 확인

**준비물:**
- 라이다 USB 연결

**실행:**
```bash
cd 통합
python tests/test_lidar_visual.py
```

**예상 화면:**
- 라이다 스캔 데이터를 극좌표 그래프로 표시
- 전방(350~10도) 범위가 빨간색으로 강조됨

**확인 사항:**
- [ ] 라이다가 회전하며 스캔하는가?
- [ ] 물체를 라이다 앞에 두면 점으로 표시되는가?
- [ ] 전방 범위(빨간색 영역)에 물체가 있으면 감지되는가?

**종료:** `Ctrl + C`

---

### 5️⃣ 카메라 테스트
**목적:** 카메라 2대가 작동하고 차선 인식이 되는지 확인

**준비물:**
- 카메라 2대 USB 연결
- (선택) 테스트용 차선 (검은 테이프)

**실행:**
```bash
cd 통합
python tests/test_camera.py
```

**예상 화면:**
- 카메라 영상 2개 창 표시
- 프레임마다 차선 방향 표시

**확인 사항:**
- [ ] 카메라 영상이 정상적으로 보이는가?
- [ ] 차선을 비추면 방향이 감지되는가?
  - 직선 차선 → `FORWARD`
  - 왼쪽으로 꺾인 차선 → `LEFT`
  - 오른쪽으로 꺾인 차선 → `RIGHT`

**종료:** `q` 키

---

## 🔗 통합 테스트

### 6️⃣ 통합 테스트 (모든 센서 + 모터)
**목적:** 모든 하드웨어가 함께 작동하는지 확인

**준비물:**
- 모든 센서 연결 (라이다, 카메라 2대, 아두이노)
- 모터 드라이브 전원 연결

**⚠️ 주의:** 차량을 들어올리거나 안전한 공간에서 테스트!

**실행:**
```bash
cd 통합
python tests/test_integration.py
```

**예상 출력:**
```
======================================================================
프레임 5
======================================================================
[차선 감지] 직진 (FORWARD)
[라이다] ✓ 안전 (최근거리: 1500mm)
[초음파 센서]
  전방(F):     100 cm
  좌전방(FL):  100 cm
  ...
[모터 명령] ⬆️ 전진
======================================================================
```

**확인 사항:**
- [ ] 모든 센서 데이터가 정상적으로 출력되는가?
- [ ] 차선 방향에 따라 모터 명령이 바뀌는가?
- [ ] 장애물을 앞에 두면 정지하는가?
- [ ] 카메라 영상이 표시되는가?

**종료:** `q` 키 또는 `Ctrl + C`

---

## 🏁 실제 자율주행

### 7️⃣ 메인 프로그램 실행
**목적:** 실제 자율주행 시스템 구동

**⚠️ 안전 수칙:**
1. 넓은 공간에서 테스트
2. 차량 주변에 장애물 없는지 확인
3. 언제든 차량을 잡을 수 있도록 준비
4. 긴급 시 `Ctrl + C`로 즉시 정지

**실행:**
```bash
cd 통합
python main.py
```

**확인 사항:**
- [ ] 차선을 따라 이동하는가?
- [ ] 좌회전/우회전이 정상적으로 되는가?
- [ ] 장애물이 있으면 정지하는가?
- [ ] 초음파 센서가 근거리 장애물을 감지하는가?

**종료:** `q` 키 또는 `Ctrl + C`

---

## 🎮 시뮬레이션 테스트

### 하드웨어 없이 로직만 테스트
시뮬레이션 모드는 **실제 하드웨어 없이** 제어 알고리즘을 검증합니다.

**장점:**
- 하드웨어 고장 없이 로직 검증
- 다양한 시나리오 자동 테스트
- 안전하게 엣지 케이스 확인

**실행:**
```bash
cd 통합
python tests/test_simulation.py
```

**테스트 시나리오:**
1. 직진 주행 (장애물 없음)
2. 좌회전
3. 우회전
4. 전방 장애물 감지 (라이다)
5. 전방 장애물 감지 (초음파)
6. 좌전방 장애물
7. 우전방 장애물
8. 차선 인식 실패

**모든 시나리오가 PASS하면 로직이 올바르게 작동하는 것입니다!**

---

## 🛠️ 문제 해결

### 문제 1: "No module named 'serial'"
**원인:** pyserial 라이브러리 미설치

**해결:**
```bash
pip install pyserial
```

---

### 문제 2: "No module named 'cv2'"
**원인:** OpenCV 라이브러리 미설치

**해결:**
```bash
pip install opencv-python
```

---

### 문제 3: "Access denied to COM4"
**원인:**
- 다른 프로그램이 포트를 사용 중
- 아두이노 IDE 시리얼 모니터가 열려있음

**해결:**
1. 아두이노 IDE 시리얼 모니터 닫기
2. 모든 Python 프로그램 종료 후 재시작
3. 아두이노 USB 재연결

---

### 문제 4: 라이다가 작동하지 않음
**증상:** "RPLidarException: Failed to get health"

**해결:**
1. 라이다 USB 재연결
2. COM 포트 번호 확인
3. 라이다 전원 확인
4. [Lib_LiDAR.py](modules/lidar/Lib_LiDAR.py)의 timeout 값 증가:
   ```python
   self.lidar = RPLidar(port, timeout=5)  # 2 → 5
   ```

---

### 문제 5: 카메라가 인식되지 않음
**증상:** "Camera Channel0 is not enabled!"

**해결:**
1. 카메라 USB 재연결
2. 다른 USB 포트 사용
3. 카메라 개수 설정 확인:
   ```python
   CAMERA_COUNT = 1  # 카메라 1개만 사용
   ```

---

### 문제 6: 초음파 센서 값이 0만 나옴
**원인:**
- 센서 연결 불량
- 아두이노 코드 미업로드

**해결:**
1. 초음파 센서 Trig/Echo 핀 연결 확인
2. [motor_control.ino](firmware/motor_control/motor_control.ino) 아두이노에 업로드
3. 아두이노 시리얼 모니터로 직접 확인:
   ```
   F:25,FL:30,FR:28,R:50,RL:45,RR:48
   ```

---

### 문제 7: 모터가 작동하지 않음
**원인:**
- 모터 드라이브 전원 미연결
- PWM 핀 연결 불량

**해결:**
1. 배터리 전압 확인 (최소 12V)
2. 모터 드라이브 전원 LED 확인
3. 모터 연결 핀 확인:
   - DC 모터: 핀 3, 5
   - 서보 모터: 핀 9

---

### 문제 8: 차선 인식이 안 됨
**원인:**
- 조명 조건 불량
- 차선이 너무 흐림
- 카메라 각도 문제

**해결:**
1. 밝은 조명 사용
2. 검은색 테이프로 명확한 차선 제작
3. 카메라 각도 조정 (바닥을 향하게)
4. [config.py](config.py)에서 임계값 조정:
   ```python
   LANE_THRESHOLD = 100  # 150 → 100 (더 민감하게)
   ```

---

## 📊 테스트 체크리스트

### 개별 센서 테스트
- [ ] 시뮬레이션 테스트 완료 (8개 시나리오 PASS)
- [ ] 초음파 센서 6개 정상 작동
- [ ] 모터 제어 정상 (전진/후진/좌회전/우회전)
- [ ] 라이다 스캔 정상
- [ ] 카메라 2대 정상 작동
- [ ] 차선 인식 정상

### 통합 테스트
- [ ] 모든 센서 데이터 동시 수신
- [ ] 센서에 따라 모터 명령 변경
- [ ] 장애물 감지 시 정지
- [ ] 영상 표시 정상

### 실제 주행 테스트
- [ ] 직진 주행 안정적
- [ ] 좌회전/우회전 정상
- [ ] 장애물 회피 정상
- [ ] 긴급 정지 작동

---

## 🎯 오늘의 목표 달성 체크

### 목표 1: 구동 테스트
- [ ] 모터가 정상적으로 작동하는가?
- [ ] 전진/후진/좌회전/우회전이 모두 되는가?
- [ ] 서보모터 조향이 정확한가?

### 목표 2: 센서 반응 확인
- [ ] 라이다가 장애물을 감지하면 정지하는가?
- [ ] 초음파 센서가 근거리 장애물을 감지하는가?
- [ ] 카메라가 차선을 인식하는가?
- [ ] 센서 값에 따라 차량이 올바르게 반응하는가?

---

## 📞 추가 지원

문제가 해결되지 않으면:
1. 각 테스트 프로그램의 오류 메시지 확인
2. 시리얼 모니터로 아두이노 직접 확인
3. 센서 연결 상태 재확인

---

**행운을 빕니다! 🚗💨**
